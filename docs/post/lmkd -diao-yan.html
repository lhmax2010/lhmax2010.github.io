<!DOCTYPE html>
<html data-color-mode="light" data-dark-theme="dark" data-light-theme="light" lang="zh-CN">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href='https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/Primer/21.0.7/primer.css' rel='stylesheet' />
    
    <link rel="icon" href="https://github.githubassets.com/favicons/favicon.svg"><script>
        let theme = localStorage.getItem("meek_theme") || "light";
        document.documentElement.setAttribute("data-color-mode", theme);
    </script>
<meta name="description" content="lmkd流程图
sequenceDiagram
autonumber
participant AMS as AMS
participant PL as ProcessList
participant KPSI as Kernel PSI
participant KVM as Kernel vmpressure
participant LMK as lmkd main
participant CTRL as ctrl handler
participant PSI as psi handler
participant VMP as vmpressure handler
participant PRIO as procprio handler
participant KILL as killer

%% Startup
AMS->>LMK: main - lmkd.c - entry start lmkd
LMK->>LMK: init - lmkd.c - init data and minfree
LMK->>LMK: init_sock - lmkd.c - create ctrl socket
LMK->>LMK: init_cgroup - lmkd.c - setup memcg paths
LMK->>LMK: epoll_main_loop - lmkd.c - register fds and loop

%% AMS & ProcessList scoring
AMS->>PL: computeOomAdjLocked - ProcessList.java - compute oom_score_adj
PL-->>AMS: return oom_score_adj
AMS->>LMK: send procprio via ctrl socket
LMK->>PRIO: procprio_handler - lmkd.c - handle priority message
PRIO->>PRIO: proc_setprio - lmkd.c - update procprio table

%% Control commands
AMS-->>LMK: ctrl command minfree or procprio or kill
LMK->>CTRL: ctrl_handler - lmkd.c - receive command
CTRL->>CTRL: ctrl_command_handler - lmkd.c - parse command
alt set minfree
  CTRL->>CTRL: cmd_target - lmkd.c - update minfree thresholds
else update procprio
  CTRL->>PRIO: cmd_procprio - lmkd.c - refresh priority table
else force kill
  CTRL->>KILL: cmd_kill - lmkd.c - trigger kill path
end

%% PSI event with decision gates
KPSI-->>LMK: PSI event from /proc/pressure/memory
LMK->>PSI: psi_event_handler - lmkd_psi.c - psi event entry
PSI->>PSI: handle_psi_event - lmkd_psi.c - read psi metrics
PSI->>PSI: evaluate_thrashing - lmkd_psi.c - compute thrashing ratio
alt Gate1 threshold reached
  PSI->>PSI: compute distance_to_threshold - hysteresis
  alt Gate2 distance small enough
    PSI->>PSI: check_backoff - rate limit
    alt Gate3 backoff expired
      alt Gate4 thrashing high
        PSI->>KILL: do_kill - lmkd.c - enter kill path
      else thrashing low
        PSI-->>LMK: return to loop
      end
    else backoff not expired
      PSI-->>LMK: return to loop
    end
  else distance too large
    PSI-->>LMK: return to loop
  end
else threshold not reached
  PSI-->>LMK: return to loop
end

%% vmpressure path
KVM-->>LMK: vmpressure event
LMK->>VMP: vmpressure_handler - lmkd_vmpressure.c - entry
VMP->>VMP: handle_vmpressure - lmkd_vmpressure.c - process pressure level
VMP->>VMP: update_reclaim_targets - lmkd_vmpressure.c - tune reclaim
VMP-->>LMK: return to loop

%% Kill path using AMS scores
KILL->>KILL: kill_some_processes - lmkd.c - collect meminfo and psi
KILL->>KILL: find_victim_process - lmkd.c - build candidate list
KILL->>KILL: proc_adj_sort - lmkd.c - sort by adj rss swapin refault
KILL->>KILL: select_and_kill_process - lmkd.c - pick victim
KILL->>KILL: send_sigkill - lmkd.c - send SIGKILL
KILL->>KILL: reclaim_pages_wait - lmkd.c - wait reclaim
KILL->>AMS: stats_write - lmkd_stats.c - report to statsd and AM
KILL-->>LMK: back to epoll loop

lmkd的优化思路
。">
<meta property="og:title" content="lmkd 调研">
<meta property="og:description" content="lmkd流程图
sequenceDiagram
autonumber
participant AMS as AMS
participant PL as ProcessList
participant KPSI as Kernel PSI
participant KVM as Kernel vmpressure
participant LMK as lmkd main
participant CTRL as ctrl handler
participant PSI as psi handler
participant VMP as vmpressure handler
participant PRIO as procprio handler
participant KILL as killer

%% Startup
AMS->>LMK: main - lmkd.c - entry start lmkd
LMK->>LMK: init - lmkd.c - init data and minfree
LMK->>LMK: init_sock - lmkd.c - create ctrl socket
LMK->>LMK: init_cgroup - lmkd.c - setup memcg paths
LMK->>LMK: epoll_main_loop - lmkd.c - register fds and loop

%% AMS & ProcessList scoring
AMS->>PL: computeOomAdjLocked - ProcessList.java - compute oom_score_adj
PL-->>AMS: return oom_score_adj
AMS->>LMK: send procprio via ctrl socket
LMK->>PRIO: procprio_handler - lmkd.c - handle priority message
PRIO->>PRIO: proc_setprio - lmkd.c - update procprio table

%% Control commands
AMS-->>LMK: ctrl command minfree or procprio or kill
LMK->>CTRL: ctrl_handler - lmkd.c - receive command
CTRL->>CTRL: ctrl_command_handler - lmkd.c - parse command
alt set minfree
  CTRL->>CTRL: cmd_target - lmkd.c - update minfree thresholds
else update procprio
  CTRL->>PRIO: cmd_procprio - lmkd.c - refresh priority table
else force kill
  CTRL->>KILL: cmd_kill - lmkd.c - trigger kill path
end

%% PSI event with decision gates
KPSI-->>LMK: PSI event from /proc/pressure/memory
LMK->>PSI: psi_event_handler - lmkd_psi.c - psi event entry
PSI->>PSI: handle_psi_event - lmkd_psi.c - read psi metrics
PSI->>PSI: evaluate_thrashing - lmkd_psi.c - compute thrashing ratio
alt Gate1 threshold reached
  PSI->>PSI: compute distance_to_threshold - hysteresis
  alt Gate2 distance small enough
    PSI->>PSI: check_backoff - rate limit
    alt Gate3 backoff expired
      alt Gate4 thrashing high
        PSI->>KILL: do_kill - lmkd.c - enter kill path
      else thrashing low
        PSI-->>LMK: return to loop
      end
    else backoff not expired
      PSI-->>LMK: return to loop
    end
  else distance too large
    PSI-->>LMK: return to loop
  end
else threshold not reached
  PSI-->>LMK: return to loop
end

%% vmpressure path
KVM-->>LMK: vmpressure event
LMK->>VMP: vmpressure_handler - lmkd_vmpressure.c - entry
VMP->>VMP: handle_vmpressure - lmkd_vmpressure.c - process pressure level
VMP->>VMP: update_reclaim_targets - lmkd_vmpressure.c - tune reclaim
VMP-->>LMK: return to loop

%% Kill path using AMS scores
KILL->>KILL: kill_some_processes - lmkd.c - collect meminfo and psi
KILL->>KILL: find_victim_process - lmkd.c - build candidate list
KILL->>KILL: proc_adj_sort - lmkd.c - sort by adj rss swapin refault
KILL->>KILL: select_and_kill_process - lmkd.c - pick victim
KILL->>KILL: send_sigkill - lmkd.c - send SIGKILL
KILL->>KILL: reclaim_pages_wait - lmkd.c - wait reclaim
KILL->>AMS: stats_write - lmkd_stats.c - report to statsd and AM
KILL-->>LMK: back to epoll loop

lmkd的优化思路
。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://lhmax2010.github.io/post/lmkd%20-diao-yan.html">
<meta property="og:image" content="https://github.githubassets.com/favicons/favicon.svg">
<title>lmkd 调研</title>



</head>
<style>
body{box-sizing: border-box;min-width: 200px;max-width: 900px;margin: 20px auto;padding: 45px;font-size: 16px;font-family: sans-serif;line-height: 1.25;}
#header{display:flex;padding-bottom:8px;border-bottom: 1px solid var(--borderColor-muted, var(--color-border-muted));margin-bottom: 16px;}
#footer {margin-top:64px; text-align: center;font-size: small;}

</style>

<style>
.postTitle{margin: auto 0;font-size:40px;font-weight:bold;}
.title-right{display:flex;margin:auto 0 0 auto;}
.title-right .circle{padding: 14px 16px;margin-right:8px;}
#postBody{border-bottom: 1px solid var(--color-border-default);padding-bottom:36px;}
#postBody hr{height:2px;}
#cmButton{height:48px;margin-top:48px;}
#comments{margin-top:64px;}
.g-emoji{font-size:24px;}
@media (max-width: 600px) {
    body {padding: 8px;}
    .postTitle{font-size:24px;}
}

</style>




<body>
    <div id="header">
<h1 class="postTitle">lmkd 调研</h1>
<div class="title-right">
    <a href="https://lhmax2010.github.io" id="buttonHome" class="btn btn-invisible circle" title="首页">
        <svg class="octicon" width="16" height="16">
            <path id="pathHome" fill-rule="evenodd"></path>
        </svg>
    </a>
    
    <a href="https://github.com/lhmax2010/lhmax2010.github.io/issues/13" target="_blank" class="btn btn-invisible circle" title="Issue">
        <svg class="octicon" width="16" height="16">
            <path id="pathIssue" fill-rule="evenodd"></path>
        </svg>
    </a>
    

    <a class="btn btn-invisible circle" onclick="modeSwitch();" title="切换主题">
        <svg class="octicon" width="16" height="16" >
            <path id="themeSwitch" fill-rule="evenodd"></path>
        </svg>
    </a>

</div>
</div>
    <div id="content">
<div class="markdown-body" id="postBody"><p>lmkd流程图<br>
sequenceDiagram<br>
autonumber<br>
participant AMS as AMS<br>
participant PL as ProcessList<br>
participant KPSI as Kernel PSI<br>
participant KVM as Kernel vmpressure<br>
participant LMK as lmkd main<br>
participant CTRL as ctrl handler<br>
participant PSI as psi handler<br>
participant VMP as vmpressure handler<br>
participant PRIO as procprio handler<br>
participant KILL as killer</p>
<p>%% Startup<br>
AMS-&gt;&gt;LMK: main - lmkd.c - entry start lmkd<br>
LMK-&gt;&gt;LMK: init - lmkd.c - init data and minfree<br>
LMK-&gt;&gt;LMK: init_sock - lmkd.c - create ctrl socket<br>
LMK-&gt;&gt;LMK: init_cgroup - lmkd.c - setup memcg paths<br>
LMK-&gt;&gt;LMK: epoll_main_loop - lmkd.c - register fds and loop</p>
<p>%% AMS &amp; ProcessList scoring<br>
AMS-&gt;&gt;PL: computeOomAdjLocked - ProcessList.java - compute oom_score_adj<br>
PL--&gt;&gt;AMS: return oom_score_adj<br>
AMS-&gt;&gt;LMK: send procprio via ctrl socket<br>
LMK-&gt;&gt;PRIO: procprio_handler - lmkd.c - handle priority message<br>
PRIO-&gt;&gt;PRIO: proc_setprio - lmkd.c - update procprio table</p>
<p>%% Control commands<br>
AMS--&gt;&gt;LMK: ctrl command minfree or procprio or kill<br>
LMK-&gt;&gt;CTRL: ctrl_handler - lmkd.c - receive command<br>
CTRL-&gt;&gt;CTRL: ctrl_command_handler - lmkd.c - parse command<br>
alt set minfree<br>
CTRL-&gt;&gt;CTRL: cmd_target - lmkd.c - update minfree thresholds<br>
else update procprio<br>
CTRL-&gt;&gt;PRIO: cmd_procprio - lmkd.c - refresh priority table<br>
else force kill<br>
CTRL-&gt;&gt;KILL: cmd_kill - lmkd.c - trigger kill path<br>
end</p>
<p>%% PSI event with decision gates<br>
KPSI--&gt;&gt;LMK: PSI event from /proc/pressure/memory<br>
LMK-&gt;&gt;PSI: psi_event_handler - lmkd_psi.c - psi event entry<br>
PSI-&gt;&gt;PSI: handle_psi_event - lmkd_psi.c - read psi metrics<br>
PSI-&gt;&gt;PSI: evaluate_thrashing - lmkd_psi.c - compute thrashing ratio<br>
alt Gate1 threshold reached<br>
PSI-&gt;&gt;PSI: compute distance_to_threshold - hysteresis<br>
alt Gate2 distance small enough<br>
PSI-&gt;&gt;PSI: check_backoff - rate limit<br>
alt Gate3 backoff expired<br>
alt Gate4 thrashing high<br>
PSI-&gt;&gt;KILL: do_kill - lmkd.c - enter kill path<br>
else thrashing low<br>
PSI--&gt;&gt;LMK: return to loop<br>
end<br>
else backoff not expired<br>
PSI--&gt;&gt;LMK: return to loop<br>
end<br>
else distance too large<br>
PSI--&gt;&gt;LMK: return to loop<br>
end<br>
else threshold not reached<br>
PSI--&gt;&gt;LMK: return to loop<br>
end</p>
<p>%% vmpressure path<br>
KVM--&gt;&gt;LMK: vmpressure event<br>
LMK-&gt;&gt;VMP: vmpressure_handler - lmkd_vmpressure.c - entry<br>
VMP-&gt;&gt;VMP: handle_vmpressure - lmkd_vmpressure.c - process pressure level<br>
VMP-&gt;&gt;VMP: update_reclaim_targets - lmkd_vmpressure.c - tune reclaim<br>
VMP--&gt;&gt;LMK: return to loop</p>
<p>%% Kill path using AMS scores<br>
KILL-&gt;&gt;KILL: kill_some_processes - lmkd.c - collect meminfo and psi<br>
KILL-&gt;&gt;KILL: find_victim_process - lmkd.c - build candidate list<br>
KILL-&gt;&gt;KILL: proc_adj_sort - lmkd.c - sort by adj rss swapin refault<br>
KILL-&gt;&gt;KILL: select_and_kill_process - lmkd.c - pick victim<br>
KILL-&gt;&gt;KILL: send_sigkill - lmkd.c - send SIGKILL<br>
KILL-&gt;&gt;KILL: reclaim_pages_wait - lmkd.c - wait reclaim<br>
KILL-&gt;&gt;AMS: stats_write - lmkd_stats.c - report to statsd and AM<br>
KILL--&gt;&gt;LMK: back to epoll loop</p>
<p>lmkd的优化思路</p></div>
<div style="font-size:small;margin-top:8px;float:right;"></div>

<button class="btn btn-block" type="button" onclick="openComments()" id="cmButton">评论</button>
<div class="comments" id="comments"></div>

</div>
    <div id="footer"><div id="footer1">Copyright © <span id="copyrightYear"></span> <a href="https://lhmax2010.github.io">Blog Title</a></div>
<div id="footer2">
    <span id="runday"></span><span>Powered by <a href="https://meekdai.com/Gmeek.html" target="_blank">Gmeek</a></span>
</div>

<script>
var now=new Date();
document.getElementById("copyrightYear").innerHTML=now.getFullYear();

if(""!=""){
    var startSite=new Date("");
    var diff=now.getTime()-startSite.getTime();
    var diffDay=Math.floor(diff/(1000*60*60*24));
    document.getElementById("runday").innerHTML="网站运行"+diffDay+"天"+" • ";
}
</script></div>
</body>
<script>
var IconList={'sun': 'M8 10.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5zM8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0V.75A.75.75 0 018 0zm0 13a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 018 13zM2.343 2.343a.75.75 0 011.061 0l1.06 1.061a.75.75 0 01-1.06 1.06l-1.06-1.06a.75.75 0 010-1.06zm9.193 9.193a.75.75 0 011.06 0l1.061 1.06a.75.75 0 01-1.06 1.061l-1.061-1.06a.75.75 0 010-1.061zM16 8a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0116 8zM3 8a.75.75 0 01-.75.75H.75a.75.75 0 010-1.5h1.5A.75.75 0 013 8zm10.657-5.657a.75.75 0 010 1.061l-1.061 1.06a.75.75 0 11-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zm-9.193 9.193a.75.75 0 010 1.06l-1.06 1.061a.75.75 0 11-1.061-1.06l1.06-1.061a.75.75 0 011.061 0z', 'moon': 'M9.598 1.591a.75.75 0 01.785-.175 7 7 0 11-8.967 8.967.75.75 0 01.961-.96 5.5 5.5 0 007.046-7.046.75.75 0 01.175-.786zm1.616 1.945a7 7 0 01-7.678 7.678 5.5 5.5 0 107.678-7.678z', 'sync': 'M1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834ZM8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5Z', 'home': 'M6.906.664a1.749 1.749 0 0 1 2.187 0l5.25 4.2c.415.332.657.835.657 1.367v7.019A1.75 1.75 0 0 1 13.25 15h-3.5a.75.75 0 0 1-.75-.75V9H7v5.25a.75.75 0 0 1-.75.75h-3.5A1.75 1.75 0 0 1 1 13.25V6.23c0-.531.242-1.034.657-1.366l5.25-4.2Zm1.25 1.171a.25.25 0 0 0-.312 0l-5.25 4.2a.25.25 0 0 0-.094.196v7.019c0 .138.112.25.25.25H5.5V8.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v5.25h2.75a.25.25 0 0 0 .25-.25V6.23a.25.25 0 0 0-.094-.195Z', 'github': 'M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z'};
var utterancesLoad=0;

let themeSettings={
    "dark": ["dark","moon","#00f0ff","dark-blue"],
    "light": ["light","sun","#ff5000","github-light"],
    "auto": ["auto","sync","","preferred-color-scheme"]
};
function changeTheme(mode, icon, color, utheme){
    document.documentElement.setAttribute("data-color-mode",mode);
    document.getElementById("themeSwitch").setAttribute("d",value=IconList[icon]);
    document.getElementById("themeSwitch").parentNode.style.color=color;
    if(utterancesLoad==1){utterancesTheme(utheme);}
}
function modeSwitch(){
    let currentMode=document.documentElement.getAttribute('data-color-mode');
    let newMode = currentMode === "light" ? "dark" : currentMode === "dark" ? "auto" : "light";
    localStorage.setItem("meek_theme", newMode);
    if(themeSettings[newMode]){
        changeTheme(...themeSettings[newMode]);
    }
}
function utterancesTheme(theme){
    const message={type:'set-theme',theme: theme};
    const iframe=document.getElementsByClassName('utterances-frame')[0];
    iframe.contentWindow.postMessage(message,'https://utteranc.es');
}
if(themeSettings[theme]){changeTheme(...themeSettings[theme]);}
console.log("\n %c Gmeek last https://github.com/Meekdai/Gmeek \n","padding:5px 0;background:#02d81d;color:#fff");
</script>

<script>
document.getElementById("pathHome").setAttribute("d",IconList["home"]);
document.getElementById("pathIssue").setAttribute("d",IconList["github"]);



function openComments(){
    cm=document.getElementById("comments");
    cmButton=document.getElementById("cmButton");
    cmButton.innerHTML="loading";
    span=document.createElement("span");
    span.setAttribute("class","AnimatedEllipsis");
    cmButton.appendChild(span);

    script=document.createElement("script");
    script.setAttribute("src","https://utteranc.es/client.js");
    script.setAttribute("repo","lhmax2010/lhmax2010.github.io");
    script.setAttribute("issue-term","title");
    
    if(localStorage.getItem("meek_theme")=="dark"){script.setAttribute("theme","dark-blue");}
    else if(localStorage.getItem("meek_theme")=="light") {script.setAttribute("theme","github-light");}
    else{script.setAttribute("theme","preferred-color-scheme");}
    
    script.setAttribute("crossorigin","anonymous");
    script.setAttribute("async","");
    cm.appendChild(script);

    int=self.setInterval("iFrameLoading()",200);
}

function iFrameLoading(){
    var utterances=document.getElementsByClassName('utterances');
    if(utterances.length==1){
        if(utterances[0].style.height!=""){
            utterancesLoad=1;
            int=window.clearInterval(int);
            document.getElementById("cmButton").style.display="none";
            console.log("utterances Load OK");
        }
    }
}



</script>


</html>
